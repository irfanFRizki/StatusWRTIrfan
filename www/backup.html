<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OpenWrt GitHub Backup Manager</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #333; min-height: 100vh; }
    .container { max-width: 1200px; margin: auto; padding: 20px; }
    .header { background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); border-radius: 15px; padding: 25px; margin-bottom: 25px; box-shadow: 0 8px 32px rgba(0,0,0,0.1); }
    .header h1 { text-align: center; font-size: 2.2em; color: #4a5568; margin-bottom: 20px; }
    .config-section { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; margin-bottom: 20px; }
    .input-group { display: flex; flex-direction: column; flex: 1; }
    .input-group label { margin-bottom: 5px; font-weight: 600; color: #4a5568; }
    .input-group input { padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; }
    .btn { background: linear-gradient(45deg,#667eea,#764ba2); color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s ease; }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(102,126,234,0.3); }
    .btn-success { background: linear-gradient(45deg,#48bb78,#38a169); }
    .btn-danger { background: linear-gradient(45deg,#f56565,#e53e3e); }
    .main-content { display: grid; grid-template-columns: 1fr; gap: 25px; }
    .card { background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); border-radius: 15px; padding: 25px; box-shadow: 0 8px 32px rgba(0,0,0,0.1); }
    .card h2 { font-size: 1.5em; margin-bottom: 20px; color: #4a5568; border-bottom: 2px solid #667eea; padding-bottom: 10px; }
    .breadcrumb { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 10px; }
    .breadcrumb button { background: #444; color: white; border: none; padding: 4px 10px; border-radius: 5px; cursor: pointer; }
    .breadcrumb button:hover { background: #666; }
    .search-box { margin-bottom: 10px; }
    .search-box input { padding: 8px; width: 100%; max-width: 300px; border-radius: 5px; border: none; }
    .file-list { margin-top: 15px; max-height: 300px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 8px; }
    .file-item { padding: 8px; border-bottom: 1px solid #e2e8f0; cursor: pointer; display: flex; align-items: center; gap: 10px; }
    .file-item:hover { background: #f7fafc; }
    .file-item.folder::before { content: 'üìÅ '; }
    .file-item.file::before { content: 'üìÑ '; }
    #fileContent { margin-top: 20px; background: #222; color: #f1f1f1; padding: 15px; border-radius: 8px; white-space: pre-wrap; max-height: 400px; overflow-y: auto; display: none; }
    .progress-container { display: none; margin-top: 20px; }
    .progress-bar { width: 100%; height: 20px; background: #e2e8f0; border-radius: 10px; overflow: hidden; margin: 10px 0; }
    .progress-fill { height: 100%; width: 0; background: linear-gradient(45deg,#667eea,#764ba2); transition: width 0.3s ease; }
    .log-area { margin-top: 20px; background: #2d3748; color: #e2e8f0; padding: 15px; border-radius: 8px; font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto; white-space: pre-wrap; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üöÄ OpenWrt GitHub Backup Manager</h1>
      <div class="config-section">
        <div class="input-group">
          <label for="githubToken">GitHub Token:</label>
          <input type="password" id="githubToken" placeholder="Masukkan GitHub Token Anda">
        </div>
        <button class="btn" onclick="validateGitHubToken()">üîê Validasi Token</button>
      </div>
      <div id="userInfo" style="display:none; font-weight:600;">User: <span id="githubUser"></span></div>
    </div>
    <div class="main-content">
      <div class="card">
        <h2>üìÇ Explorer & Backup</h2>
        <div id="breadcrumbNav" class="breadcrumb"></div>
        <div class="search-box">üîç <input type="text" id="searchInput" placeholder="Cari file/folder..." onkeyup="filterFiles()"></div>
        <div id="fileExplorer" class="file-list"></div>
        <div id="fileContent"></div>
        <button id="backupBtn" class="btn btn-success" onclick="backupCurrentFile()" disabled>üöÄ Backup File Terbuka</button>
        <button class="btn btn-danger" onclick="closeFile()">‚úñ Tutup File</button>
      </div>
      <div id="progressContainer" class="card progress-container">
        <h3>üìä Progress Backup</h3>
        <div class="progress-bar"><div id="progressFill" class="progress-fill"></div></div>
        <div id="progressText">0%</div>
      </div>
      <div class="card">
        <h2>üìã Log Aktivitas</h2>
        <div id="logArea" class="log-area">[INFO] Siap</div>
      </div>
    </div>
  </div>
  <script>
    let githubToken = '';
    let selectedFile = '';
    let currentPath = '/';

    function addLog(msg) {
      const la = document.getElementById('logArea');
      const t = new Date().toLocaleTimeString();
      la.textContent += `[${t}] ${msg}\n`;
      la.scrollTop = la.scrollHeight;
    }

    async function validateGitHubToken() {
      const tok = document.getElementById('githubToken').value;
      if (!tok) { addLog('‚ùå Token kosong'); return; }
      githubToken = tok;
      try {
        const res = await fetch('https://api.github.com/user', { headers: { 'Authorization': `token ${tok}` } });
        if (res.ok) {
          const data = await res.json();
          document.getElementById('githubUser').textContent = data.login;
          document.getElementById('userInfo').style.display = 'block';
          addLog('‚úÖ Token valid');
        } else {
          addLog('‚ùå Token tidak valid');
        }
      } catch (e) { addLog('‚ùå Error validasi'); }
    }

    function updateBreadcrumb(path) {
      const bc = document.getElementById('breadcrumbNav');
      const parts = path.split('/').filter(Boolean);
      let fp = '';
      bc.innerHTML = `<button onclick="scanFolder('/')">üè† Home</button>`;
      parts.forEach(p => { fp += '/' + p; bc.innerHTML += `<span>‚Ä∫</span><button onclick="scanFolder('${fp}')">${p}</button>`; });
    }

    async function scanFolder(path = '/') {
      currentPath = path;
      updateBreadcrumb(path);
      document.getElementById('fileContent').style.display = 'none';
      document.getElementById('backupBtn').disabled = true;
      try {
        const res = await fetch(`/cgi-bin/list-folder.sh?path=${encodeURIComponent(path)}`);
        const data = await res.json();
        const fe = document.getElementById('fileExplorer');
        fe.innerHTML = '';
        data.forEach(it => {
          const d = document.createElement('div');
          d.className = 'file-item ' + (it.isDirectory ? 'folder' : 'file');
          d.textContent = it.name;
          if (it.isDirectory) d.onclick = () => scanFolder(`${currentPath}/${it.name}`.replace(/\/+/g, '/'));
          else d.onclick = () => openFile(`${currentPath}/${it.name}`.replace(/\/+/g, '/'));
          fe.appendChild(d);
        });
        addLog(`üìÇ Direktori: ${path}`);
      } catch (e) { addLog('‚ùå Gagal load folder'); }
    }

    function filterFiles() {
      const q = document.getElementById('searchInput').value.toLowerCase();
      document.querySelectorAll('.file-item').forEach(i => i.style.display = i.textContent.toLowerCase().includes(q) ? 'flex' : 'none');
    }

    async function openFile(path) {
      selectedFile = path;
      try {
        const res = await fetch(`/cgi-bin/read-file.sh?path=${encodeURIComponent(path)}`);
        const txt = await res.text();
        const fc = document.getElementById('fileContent');
        fc.textContent = txt;
        fc.style.display = 'block';
        document.getElementById('backupBtn').disabled = false;
        addLog(`üìÑ Buka file: ${path}`);
      } catch {
        addLog('‚ùå Gagal baca file');
      }
    }

    function closeFile() {
      document.getElementById('fileContent').style.display = 'none';
      document.getElementById('backupBtn').disabled = true;
      addLog('‚úñ Tutup file');
    }

    async function backupCurrentFile() {
      if (!selectedFile || !githubToken) { addLog('‚ùå Pilih file & validasi token'); return; }
      showProgress(true);
      for (let p = 0; p <= 100; p += 25) {
        updateProgress(p);
        await new Promise(r => setTimeout(r, 300));
      }
      addLog(`‚úÖ Backup: ${selectedFile}`);
      setTimeout(() => showProgress(false), 500);
    }

    function showProgress(show) {
      const pc = document.getElementById('progressContainer');
      pc.style.display = show ? 'block' : 'none';
    }

    function updateProgress(v) {
      document.getElementById('progressFill').style.width = v + '%';
      document.getElementById('progressText').textContent = v + '%';
    }

    window.onload = () => scanFolder('/');
  </script>
</body>
</html>
