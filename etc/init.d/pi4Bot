#!/bin/sh /etc/rc.common

START=99
STOP=10

USE_PROCD=1

PROG=/usr/bin/python3
SCRIPT=/root/pi4Bot.py
PIDFILE=/var/run/pi4bot.pid

start_service() {
    procd_open_instance
    procd_set_param command $PROG $SCRIPT
    procd_set_param pidfile $PIDFILE
    procd_set_param respawn ${respawn_threshold:-3600} ${respawn_timeout:-5} ${respawn_retry:-5}
    procd_set_param stdout 1
    procd_set_param stderr 1
    procd_set_param user root
    procd_close_instance
}

stop_service() {
    # Kill process gracefully
    if [ -f "$PIDFILE" ]; then
        PID=$(cat $PIDFILE)
        if [ -n "$PID" ]; then
            kill -TERM $PID 2>/dev/null
            sleep 2
            # Force kill if still running
            kill -9 $PID 2>/dev/null
        fi
        rm -f $PIDFILE
    fi
}

reload_service() {
    stop
    start
}

restart() {
    stop
    sleep 2
    start
}

status() {
    if [ -f "$PIDFILE" ]; then
        PID=$(cat $PIDFILE)
        if [ -n "$PID" ] && kill -0 $PID 2>/dev/null; then
            echo "Pi4 Monitoring Bot is running (PID: $PID)"
            return 0
        else
            echo "Pi4 Monitoring Bot is not running (stale PID file)"
            rm -f $PIDFILE
            return 1
        fi
    else
        echo "Pi4 Monitoring Bot is not running"
        return 1
    fi
}